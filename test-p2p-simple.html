<!DOCTYPE html>
<html>
<head>
  <title>Simple P2P Test</title>
  <script src="https://unpkg.com/peerjs@1.5.5/dist/peerjs.min.js"></script>
</head>
<body style="background: #000; color: #fff; padding: 20px; font-family: monospace;">
  <h1>Simple P2P Connection Test</h1>
  
  <div style="margin: 20px 0;">
    <h2>Step 1: Initialize</h2>
    <button id="init" onclick="initialize()">Initialize Peer</button>
    <div id="myId" style="margin-top: 10px;"></div>
  </div>
  
  <div style="margin: 20px 0;">
    <h2>Step 2: Connect</h2>
    <input id="targetId" placeholder="Enter peer ID to connect" style="padding: 8px; width: 300px;" />
    <button onclick="connect()">Connect</button>
    <div id="status" style="margin-top: 10px; color: #ff0;"></div>
  </div>
  
  <div style="margin: 20px 0;">
    <h2>Step 3: Send Message</h2>
    <input id="message" placeholder="Type message" style="padding: 8px; width: 300px;" />
    <button onclick="send()">Send</button>
  </div>
  
  <div style="margin: 20px 0;">
    <h2>Messages</h2>
    <div id="messages" style="background: #111; padding: 10px; min-height: 100px;"></div>
  </div>
  
  <div style="margin: 20px 0;">
    <h2>Debug Log</h2>
    <pre id="log" style="background: #111; padding: 10px; max-height: 300px; overflow-y: auto; font-size: 10px;"></pre>
  </div>

  <script>
    let peer = null;
    let conn = null;
    
    function log(msg) {
      const timestamp = new Date().toISOString().split('T')[1].slice(0, -1);
      document.getElementById('log').innerHTML += `[${timestamp}] ${msg}\n`;
      console.log(msg);
    }
    
    function initialize() {
      log('Initializing peer...');
      
      peer = new Peer({
        host: 'ghostchat-signaling.teycir.workers.dev',
        port: 443,
        path: '/',
        secure: true,
        debug: 2
      });
      
      peer.on('open', (id) => {
        log(`Peer opened with ID: ${id}`);
        document.getElementById('myId').innerHTML = `<strong>Your ID:</strong> ${id}<br><button onclick="navigator.clipboard.writeText('${id}')">Copy ID</button>`;
        document.getElementById('status').innerHTML = 'Ready to connect';
        document.getElementById('status').style.color = '#0f0';
      });
      
      peer.on('connection', (incoming) => {
        log(`Incoming connection from: ${incoming.peer}`);
        setupConnection(incoming);
      });
      
      peer.on('error', (err) => {
        log(`ERROR: ${err.type} - ${err.message}`);
        document.getElementById('status').innerHTML = `Error: ${err.type}`;
        document.getElementById('status').style.color = '#f00';
      });
    }
    
    function setupConnection(connection) {
      conn = connection;
      
      conn.on('open', () => {
        log(`Connection OPEN with ${conn.peer}`);
        document.getElementById('status').innerHTML = `Connected to ${conn.peer}`;
        document.getElementById('status').style.color = '#0f0';
      });
      
      conn.on('data', (data) => {
        log(`Received: ${data}`);
        document.getElementById('messages').innerHTML += `<div style="color: #0ff;">${conn.peer}: ${data}</div>`;
      });
      
      conn.on('close', () => {
        log(`Connection CLOSED`);
        document.getElementById('status').innerHTML = 'Disconnected';
        document.getElementById('status').style.color = '#f00';
      });
      
      conn.on('error', (err) => {
        log(`Connection ERROR: ${err}`);
      });
      
      if (conn.peerConnection) {
        conn.peerConnection.addEventListener('connectionstatechange', () => {
          log(`Connection state: ${conn.peerConnection.connectionState}`);
        });
        conn.peerConnection.addEventListener('iceconnectionstatechange', () => {
          log(`ICE state: ${conn.peerConnection.iceConnectionState}`);
        });
      }
    }
    
    function connect() {
      const targetId = document.getElementById('targetId').value.trim();
      if (!targetId) {
        alert('Enter a peer ID');
        return;
      }
      
      if (!peer) {
        alert('Initialize first');
        return;
      }
      
      log(`Connecting to ${targetId}...`);
      document.getElementById('status').innerHTML = 'Connecting...';
      document.getElementById('status').style.color = '#ff0';
      
      const outgoing = peer.connect(targetId, {
        reliable: true
      });
      
      setupConnection(outgoing);
    }
    
    function send() {
      const msg = document.getElementById('message').value.trim();
      if (!msg) return;
      
      if (!conn || !conn.open) {
        alert('Not connected');
        return;
      }
      
      log(`Sending: ${msg}`);
      conn.send(msg);
      document.getElementById('messages').innerHTML += `<div style="color: #0f0;">Me: ${msg}</div>`;
      document.getElementById('message').value = '';
    }
  </script>
</body>
</html>
