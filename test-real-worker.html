<!DOCTYPE html>
<html>
<head>
  <title>Real Worker Test</title>
  <script src="https://unpkg.com/peerjs@1.5.5/dist/peerjs.min.js"></script>
</head>
<body style="background: #000; color: #fff; padding: 20px; font-family: monospace;">
  <h1>Test Cloudflare Worker vs 0.peerjs.com</h1>
  
  <div style="display: flex; gap: 20px;">
    <!-- Cloudflare Worker Test -->
    <div style="flex: 1; border: 2px solid #f00; padding: 20px;">
      <h2 style="color: #f00;">Cloudflare Worker</h2>
      <button onclick="initCloudflare()">Initialize</button>
      <div id="cf-id" style="margin: 10px 0;"></div>
      <input id="cf-target" placeholder="Target ID" style="width: 200px; padding: 5px;" />
      <button onclick="connectCloudflare()">Connect</button>
      <div id="cf-status" style="margin: 10px 0; color: #ff0;"></div>
      <input id="cf-msg" placeholder="Message" style="width: 200px; padding: 5px;" />
      <button onclick="sendCloudflare()">Send</button>
      <div id="cf-messages" style="margin: 10px 0; background: #111; padding: 10px; min-height: 100px;"></div>
      <pre id="cf-log" style="background: #111; padding: 10px; font-size: 9px; max-height: 200px; overflow-y: auto;"></pre>
    </div>
    
    <!-- 0.peerjs.com Test -->
    <div style="flex: 1; border: 2px solid #0f0; padding: 20px;">
      <h2 style="color: #0f0;">0.peerjs.com</h2>
      <button onclick="initPeerJS()">Initialize</button>
      <div id="pj-id" style="margin: 10px 0;"></div>
      <input id="pj-target" placeholder="Target ID" style="width: 200px; padding: 5px;" />
      <button onclick="connectPeerJS()">Connect</button>
      <div id="pj-status" style="margin: 10px 0; color: #ff0;"></div>
      <input id="pj-msg" placeholder="Message" style="width: 200px; padding: 5px;" />
      <button onclick="sendPeerJS()">Send</button>
      <div id="pj-messages" style="margin: 10px 0; background: #111; padding: 10px; min-height: 100px;"></div>
      <pre id="pj-log" style="background: #111; padding: 10px; font-size: 9px; max-height: 200px; overflow-y: auto;"></pre>
    </div>
  </div>

  <script>
    let cfPeer = null;
    let cfConn = null;
    let pjPeer = null;
    let pjConn = null;
    
    function log(prefix, msg) {
      const el = document.getElementById(prefix + '-log');
      el.innerHTML += `[${new Date().toISOString().split('T')[1].slice(0, -1)}] ${msg}\n`;
      el.scrollTop = el.scrollHeight;
      console.log(`[${prefix}]`, msg);
    }
    
    function initCloudflare() {
      log('cf', 'Initializing with Cloudflare Worker...');
      cfPeer = new Peer({
        host: 'ghostchat-signaling.teycir.workers.dev',
        port: 443,
        path: '/',
        secure: true,
        debug: 2
      });
      
      cfPeer.on('open', (id) => {
        log('cf', `OPEN: ${id}`);
        document.getElementById('cf-id').innerHTML = `<strong>ID:</strong> ${id}`;
        document.getElementById('cf-status').innerHTML = 'Ready';
        document.getElementById('cf-status').style.color = '#0f0';
      });
      
      cfPeer.on('connection', (conn) => {
        log('cf', `Incoming connection from: ${conn.peer}`);
        setupCfConnection(conn);
      });
      
      cfPeer.on('error', (err) => {
        log('cf', `ERROR: ${err.type} - ${err.message}`);
        document.getElementById('cf-status').innerHTML = `Error: ${err.type}`;
        document.getElementById('cf-status').style.color = '#f00';
      });
    }
    
    function setupCfConnection(conn) {
      cfConn = conn;
      
      conn.on('open', () => {
        log('cf', `Connection OPEN`);
        document.getElementById('cf-status').innerHTML = 'Connected';
        document.getElementById('cf-status').style.color = '#0f0';
      });
      
      conn.on('data', (data) => {
        log('cf', `Received: ${data}`);
        document.getElementById('cf-messages').innerHTML += `<div style="color: #0ff;">${data}</div>`;
      });
      
      conn.on('close', () => {
        log('cf', `Connection CLOSED`);
        document.getElementById('cf-status').innerHTML = 'Disconnected';
        document.getElementById('cf-status').style.color = '#f00';
      });
    }
    
    function connectCloudflare() {
      const target = document.getElementById('cf-target').value.trim();
      if (!target || !cfPeer) return;
      
      log('cf', `Connecting to ${target}...`);
      document.getElementById('cf-status').innerHTML = 'Connecting...';
      document.getElementById('cf-status').style.color = '#ff0';
      
      const conn = cfPeer.connect(target);
      setupCfConnection(conn);
    }
    
    function sendCloudflare() {
      const msg = document.getElementById('cf-msg').value.trim();
      if (!msg || !cfConn || !cfConn.open) return;
      
      log('cf', `Sending: ${msg}`);
      cfConn.send(msg);
      document.getElementById('cf-messages').innerHTML += `<div style="color: #0f0;">Me: ${msg}</div>`;
      document.getElementById('cf-msg').value = '';
    }
    
    // PeerJS functions (same pattern)
    function initPeerJS() {
      log('pj', 'Initializing with 0.peerjs.com...');
      pjPeer = new Peer({
        host: '0.peerjs.com',
        port: 443,
        path: '/',
        secure: true,
        debug: 2
      });
      
      pjPeer.on('open', (id) => {
        log('pj', `OPEN: ${id}`);
        document.getElementById('pj-id').innerHTML = `<strong>ID:</strong> ${id}`;
        document.getElementById('pj-status').innerHTML = 'Ready';
        document.getElementById('pj-status').style.color = '#0f0';
      });
      
      pjPeer.on('connection', (conn) => {
        log('pj', `Incoming connection from: ${conn.peer}`);
        setupPjConnection(conn);
      });
      
      pjPeer.on('error', (err) => {
        log('pj', `ERROR: ${err.type} - ${err.message}`);
        document.getElementById('pj-status').innerHTML = `Error: ${err.type}`;
        document.getElementById('pj-status').style.color = '#f00';
      });
    }
    
    function setupPjConnection(conn) {
      pjConn = conn;
      
      conn.on('open', () => {
        log('pj', `Connection OPEN`);
        document.getElementById('pj-status').innerHTML = 'Connected';
        document.getElementById('pj-status').style.color = '#0f0';
      });
      
      conn.on('data', (data) => {
        log('pj', `Received: ${data}`);
        document.getElementById('pj-messages').innerHTML += `<div style="color: #0ff;">${data}</div>`;
      });
      
      conn.on('close', () => {
        log('pj', `Connection CLOSED`);
        document.getElementById('pj-status').innerHTML = 'Disconnected';
        document.getElementById('pj-status').style.color = '#f00';
      });
    }
    
    function connectPeerJS() {
      const target = document.getElementById('pj-target').value.trim();
      if (!target || !pjPeer) return;
      
      log('pj', `Connecting to ${target}...`);
      document.getElementById('pj-status').innerHTML = 'Connecting...';
      document.getElementById('pj-status').style.color = '#ff0';
      
      const conn = pjPeer.connect(target);
      setupPjConnection(conn);
    }
    
    function sendPeerJS() {
      const msg = document.getElementById('pj-msg').value.trim();
      if (!msg || !pjConn || !pjConn.open) return;
      
      log('pj', `Sending: ${msg}`);
      pjConn.send(msg);
      document.getElementById('pj-messages').innerHTML += `<div style="color: #0f0;">Me: ${msg}</div>`;
      document.getElementById('pj-msg').value = '';
    }
  </script>
</body>
</html>
