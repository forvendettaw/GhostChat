<!DOCTYPE html>
<html>
<head>
  <title>Cloudflare Worker PeerJS Test</title>
  <meta charset="UTF-8">
</head>
<body style="background: #000; color: #fff; padding: 40px; font-family: monospace;">
  <h1>Cloudflare Worker PeerJS Server Test</h1>
  
  <div style="margin: 20px 0; padding: 20px; background: #1a1a1a; border: 1px solid #333; border-radius: 8px;">
    <h2>Server Configuration</h2>
    <div style="margin: 10px 0;">
      <label>Host: <input id="host" value="ghostchat-signaling.teycir.workers.dev" style="width: 300px; padding: 4px;" /></label>
    </div>
    <div style="margin: 10px 0;">
      <label>Port: <input id="port" value="443" style="width: 100px; padding: 4px;" /></label>
    </div>
    <div style="margin: 10px 0;">
      <label>Path: <input id="path" value="/peerjs" style="width: 200px; padding: 4px;" /></label>
    </div>
    <div style="margin: 10px 0;">
      <label><input type="checkbox" id="secure" checked /> Use HTTPS/WSS</label>
    </div>
    <button onclick="testConnection()" style="padding: 8px 16px; margin-top: 10px; cursor: pointer;">Test Connection</button>
  </div>

  <div style="margin: 20px 0; padding: 20px; background: #1a1a1a; border: 1px solid #333; border-radius: 8px;">
    <h2>Test 1: HTTP Endpoint</h2>
    <div id="test1">Click "Test Connection" to start</div>
  </div>

  <div style="margin: 20px 0; padding: 20px; background: #1a1a1a; border: 1px solid #333; border-radius: 8px;">
    <h2>Test 2: WebSocket Connection</h2>
    <div id="test2">Waiting...</div>
  </div>

  <div style="margin: 20px 0; padding: 20px; background: #1a1a1a; border: 1px solid #333; border-radius: 8px;">
    <h2>Test 3: PeerJS Client Connection</h2>
    <div id="test3">Waiting...</div>
  </div>

  <div style="margin: 20px 0; padding: 20px; background: #1a1a1a; border: 1px solid #333; border-radius: 8px;">
    <h2>Console Logs</h2>
    <pre id="logs" style="background: #000; padding: 10px; border-radius: 4px; max-height: 300px; overflow-y: auto;"></pre>
  </div>

  <script src="https://unpkg.com/peerjs@1.5.5/dist/peerjs.min.js"></script>
  <script>
    let logBuffer = [];
    
    function log(msg, color = '#fff') {
      const timestamp = new Date().toISOString().split('T')[1].slice(0, -1);
      logBuffer.push(`<span style="color: ${color}">[${timestamp}] ${msg}</span>`);
      document.getElementById('logs').innerHTML = logBuffer.join('\n');
      console.log(msg);
    }

    async function testConnection() {
      const host = document.getElementById('host').value;
      const port = parseInt(document.getElementById('port').value);
      const path = document.getElementById('path').value;
      const secure = document.getElementById('secure').checked;
      
      const httpProto = secure ? 'https' : 'http';
      const wsProto = secure ? 'wss' : 'ws';
      const portStr = (secure && port === 443) || (!secure && port === 80) ? '' : `:${port}`;
      
      logBuffer = [];
      log('Starting tests...', '#0ff');
      
      // Test 1: HTTP Endpoint
      log('Test 1: Testing HTTP endpoint...', '#ff0');
      document.getElementById('test1').innerHTML = 'Testing...';
      
      try {
        const httpUrl = `${httpProto}://${host}${portStr}${path}`;
        log(`Fetching: ${httpUrl}`, '#888');
        
        const response = await fetch(httpUrl);
        const text = await response.text();
        
        log(`HTTP Status: ${response.status}`, response.status === 200 ? '#0f0' : '#f00');
        log(`Response: ${text.substring(0, 100)}`, '#888');
        
        if (response.status === 200) {
          document.getElementById('test1').innerHTML = '<span style="color: #0f0;">✓ PASS</span> - HTTP endpoint accessible';
        } else {
          document.getElementById('test1').innerHTML = `<span style="color: #f00;">✗ FAIL</span> - HTTP ${response.status}`;
        }
      } catch (err) {
        log(`HTTP Error: ${err.message}`, '#f00');
        document.getElementById('test1').innerHTML = `<span style="color: #f00;">✗ FAIL</span> - ${err.message}`;
      }
      
      // Test 2: WebSocket Connection
      log('Test 2: Testing WebSocket...', '#ff0');
      document.getElementById('test2').innerHTML = 'Testing...';
      
      try {
        const wsUrl = `${wsProto}://${host}${portStr}${path}?key=peerjs&id=test-${Date.now()}&token=test&version=1.5.5`;
        log(`Connecting to: ${wsUrl}`, '#888');
        
        const ws = new WebSocket(wsUrl);
        
        ws.onopen = () => {
          log('WebSocket OPEN', '#0f0');
          document.getElementById('test2').innerHTML = '<span style="color: #0f0;">✓ PASS</span> - WebSocket connected';
          setTimeout(() => ws.close(), 1000);
        };
        
        ws.onerror = (err) => {
          log(`WebSocket ERROR: ${err}`, '#f00');
          document.getElementById('test2').innerHTML = '<span style="color: #f00;">✗ FAIL</span> - WebSocket error';
        };
        
        ws.onclose = (event) => {
          log(`WebSocket CLOSE: code=${event.code}, reason=${event.reason}`, '#888');
        };
      } catch (err) {
        log(`WebSocket Error: ${err.message}`, '#f00');
        document.getElementById('test2').innerHTML = `<span style="color: #f00;">✗ FAIL</span> - ${err.message}`;
      }
      
      // Test 3: PeerJS Client
      log('Test 3: Testing PeerJS client...', '#ff0');
      document.getElementById('test3').innerHTML = 'Testing...';
      
      try {
        const peer = new Peer({
          host: host,
          port: port,
          path: path,
          secure: secure,
          debug: 3
        });
        
        peer.on('open', (id) => {
          log(`PeerJS OPEN: ID=${id}`, '#0f0');
          document.getElementById('test3').innerHTML = `<span style="color: #0f0;">✓ PASS</span> - PeerJS connected, ID: ${id}`;
          setTimeout(() => peer.destroy(), 2000);
        });
        
        peer.on('error', (err) => {
          log(`PeerJS ERROR: ${err.type} - ${err.message}`, '#f00');
          document.getElementById('test3').innerHTML = `<span style="color: #f00;">✗ FAIL</span> - ${err.type}: ${err.message}`;
        });
      } catch (err) {
        log(`PeerJS Error: ${err.message}`, '#f00');
        document.getElementById('test3').innerHTML = `<span style="color: #f00;">✗ FAIL</span> - ${err.message}`;
      }
    }
    
    // Auto-test on load
    setTimeout(testConnection, 500);
  </script>
</body>
</html>
