<!DOCTYPE html>
<html>
<head>
  <title>Cloudflare Deployment Test</title>
  <meta charset="UTF-8">
</head>
<body style="background: #000; color: #fff; padding: 40px; font-family: monospace;">
  <h1>GhostChat Cloudflare Deployment Test</h1>
  
  <div style="margin: 20px 0; padding: 20px; background: #1a1a1a; border: 1px solid #333; border-radius: 8px;">
    <h2>Test 1: Static Files</h2>
    <div id="test1">Testing...</div>
  </div>

  <div style="margin: 20px 0; padding: 20px; background: #1a1a1a; border: 1px solid #333; border-radius: 8px;">
    <h2>Test 2: PeerJS Connection</h2>
    <div id="test2">Testing...</div>
  </div>

  <div style="margin: 20px 0; padding: 20px; background: #1a1a1a; border: 1px solid #333; border-radius: 8px;">
    <h2>Test 3: QR Code API</h2>
    <div id="test3">Testing...</div>
    <div id="qr-result"></div>
  </div>

  <div style="margin: 20px 0; padding: 20px; background: #1a1a1a; border: 1px solid #333; border-radius: 8px;">
    <h2>Test 4: CSP Headers</h2>
    <div id="test4">Testing...</div>
  </div>

  <script src="https://unpkg.com/peerjs@1.5.5/dist/peerjs.min.js"></script>
  <script>
    // Test 1: Static files loaded
    setTimeout(() => {
      document.getElementById('test1').innerHTML = '<span style="color: #0f0;">✓ PASS</span> - Static HTML loaded successfully';
    }, 100);

    // Test 2: PeerJS connection
    try {
      const peer = new Peer({
        host: '0.peerjs.com',
        port: 443,
        path: '/',
        secure: true
      });

      peer.on('open', (id) => {
        document.getElementById('test2').innerHTML = `<span style="color: #0f0;">✓ PASS</span> - PeerJS connected, ID: ${id}`;
        peer.destroy();
      });

      peer.on('error', (err) => {
        document.getElementById('test2').innerHTML = `<span style="color: #f00;">✗ FAIL</span> - PeerJS error: ${err.type}`;
      });

      setTimeout(() => {
        if (!peer.id) {
          document.getElementById('test2').innerHTML = '<span style="color: #ff0;">⚠ TIMEOUT</span> - PeerJS connection timeout';
        }
      }, 10000);
    } catch (err) {
      document.getElementById('test2').innerHTML = `<span style="color: #f00;">✗ FAIL</span> - ${err.message}`;
    }

    // Test 3: QR Code API
    const testUrl = window.location.href;
    const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(testUrl)}`;
    
    const img = new Image();
    img.onload = () => {
      document.getElementById('test3').innerHTML = '<span style="color: #0f0;">✓ PASS</span> - QR code API accessible';
      document.getElementById('qr-result').innerHTML = `<img src="${qrUrl}" style="margin-top: 10px; border: 2px solid #333;" />`;
    };
    img.onerror = () => {
      document.getElementById('test3').innerHTML = '<span style="color: #f00;">✗ FAIL</span> - QR code API blocked (CSP issue)';
    };
    img.src = qrUrl;

    // Test 4: CSP Headers
    fetch(window.location.href)
      .then(response => {
        const csp = response.headers.get('Content-Security-Policy');
        if (csp) {
          const hasQR = csp.includes('api.qrserver.com');
          if (hasQR) {
            document.getElementById('test4').innerHTML = '<span style="color: #0f0;">✓ PASS</span> - CSP allows QR API';
          } else {
            document.getElementById('test4').innerHTML = '<span style="color: #ff0;">⚠ WARNING</span> - CSP present but QR API not whitelisted';
          }
        } else {
          document.getElementById('test4').innerHTML = '<span style="color: #ff0;">⚠ WARNING</span> - No CSP headers (Cloudflare Pages ignores next.config.js headers)';
        }
      })
      .catch(err => {
        document.getElementById('test4').innerHTML = `<span style="color: #f00;">✗ FAIL</span> - ${err.message}`;
      });
  </script>
</body>
</html>
