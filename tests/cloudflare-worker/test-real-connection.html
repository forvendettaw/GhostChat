<!DOCTYPE html>
<html>
<head>
  <title>Cloudflare Worker Real Connection Test</title>
  <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
  <style>
    body { font-family: monospace; padding: 20px; background: #000; color: #0f0; }
    .log { margin: 5px 0; }
    .success { color: #0f0; }
    .error { color: #f00; }
    .info { color: #ff0; }
  </style>
</head>
<body>
  <h2>Real-World Connection Test</h2>
  <div id="log"></div>
  
  <script>
    const CLOUDFLARE_CONFIG = {
      host: 'ghostchat-signaling.teycir.workers.dev',
      port: 443,
      path: '/peerjs',
      secure: true,
      debug: 2
    };

    function log(msg, type = 'info') {
      const div = document.createElement('div');
      div.className = `log ${type}`;
      div.textContent = msg;
      document.getElementById('log').appendChild(div);
      console.log(msg);
    }

    async function testRealConnection() {
      log('=== Real-World Connection Test ===', 'info');
      log('Goal: 2 peers connect via Cloudflare Worker and exchange messages', 'info');
      log('', 'info');
      
      log('Step 1: Creating Peer1...', 'info');
      const peer1 = new Peer(CLOUDFLARE_CONFIG);
      
      peer1.on('open', (id) => {
        log(`✅ Peer1 connected with ID: ${id}`, 'success');
        log('', 'info');
        
        log('Step 2: Creating Peer2...', 'info');
        const peer2 = new Peer(CLOUDFLARE_CONFIG);
        
        peer2.on('open', (id2) => {
          log(`✅ Peer2 connected with ID: ${id2}`, 'success');
          log('', 'info');
          
          log(`Step 3: Peer2 connecting to Peer1 (${id})...`, 'info');
          const conn = peer2.connect(id);
          
          conn.on('open', () => {
            log('✅ P2P connection established', 'success');
            log('', 'info');
            
            log('Step 4: Peer2 sending message to Peer1...', 'info');
            conn.send('Hello from Peer2!');
          });
          
          conn.on('error', (err) => {
            log(`❌ Connection error: ${err}`, 'error');
          });
        });
        
        peer2.on('error', (err) => {
          log(`❌ Peer2 error: ${err.type} - ${err.message}`, 'error');
        });
        
        peer1.on('connection', (conn) => {
          log('✅ Peer1 received incoming connection', 'success');
          log('', 'info');
          
          conn.on('data', (data) => {
            log(`✅ Peer1 received message: "${data}"`, 'success');
            log('', 'info');
            log('=== TEST PASSED ===', 'success');
            log('✅ Peers connected via Cloudflare Worker', 'success');
            log('✅ Message exchanged successfully', 'success');
          });
          
          conn.on('error', (err) => {
            log(`❌ Data connection error: ${err}`, 'error');
          });
        });
      });
      
      peer1.on('error', (err) => {
        log(`❌ Peer1 error: ${err.type} - ${err.message}`, 'error');
      });
    }

    testRealConnection();
  </script>
</body>
</html>
